# django + django-haystack official release

## django requirement
We need to use django < 3.0 to work with the current django-haystack 2.8.1 release
with solr backend. Otherwise, we'll hit issue with "import six", which django 3.x 
already dropped support. We can specify django 2.2 with django-haystack 2.8.1 in Pipfile for the virtual environment.

## Patching django-haystack
I hit the following issue with django-haystack when doing the search. 
AttributeError: 'list' object has no attribute 'split'

Below is a link online that seems to be related.
https://github.com/django-haystack/django-haystack/issues/1200

Based on the solution provided by rifuso on Oct 23 2019 in the 
link, I made the following changes.

Change 1:
app_label, model_name = raw_result[DJANGO_CT].split('.')
=> 
app_label, model_name = raw_result[DJANGO_CT][0].split('.')
Change 2:
                result = result_class(
                    app_label,
                    model_name,
                    raw_result[DJANGO_ID],
                    raw_result["score"],
                    **additional_fields
                )
=>
                result = result_class(
                    app_label,
                    model_name,
                    raw_result[DJANGO_ID][0],
                    raw_result["score"],
                    **additional_fields
                )

## Install solr on MacOS
brew update
brew install solr

## Start Solr and create a core of blog
solr start
solr create_core -c blog
NOTE: This will use a default schema for blog core.

## Rebuild index
pythong manage.py rebuild_index

## Start server
python manage.py runserver 

After the above steps, we can do search at url address
at localhost:8000/blog/search


# django + django-haystack Github development version
## package requirement
The django-haystack development version in Github made changes for Django 3.x.  
Below is how we use the master branch of the django-haystack package in GitHub 
for our development.

To install django-haystack from Github source in the virtual environment, we 
can do the following 
pipenv install -e git+https://github.com/django-haystack/django-haystack.git#egg=django-haystack

Current head of the django-haystack is eee0db1 checked in Jun 17, 2020.

## Install solr on MacOS
brew update
brew install solr
This will install Solr 8.5.2 on MacOS at this time.

## Start Solr and create a core of blog
solr start
solr create_core -c blog
NOTE: This will use a default schema for blog core.

## Configure the schema for the blog core and reload it
The django-stack still use some old schema for previous versions of Solr. We
need make a couple of minor adjustments to make it work with Solr 8.5.2. Two
extra files, currency.xml and elevate.html in the current directory are needed
for the blog core to reload successfully with the schema generated by django
haystack. Below are the two steps to do the work. 
1. Copy currency.xml and elevate.xml to the configuration directory of the blog core.  
cp currency.xml elevate.xml /usr/local/var/lib/solr/blog/conf/
2. Reload the blog core using schema generated by django-haystack.
python manage.py build_solr_schema -c /usr/local/var/lib/solr/blog/conf -r blog

## Rebuild index 
python manage.py rebuild_index

## Start server
python manage.py runserver 

After the above steps, we can do search at url address
at localhost:8000/blog/search. 

Also we can do search autocomplete at the url address at
localhost:8000/blog/search_autocomplete.

For search autocomplete to work, we can only use the schema generated by django-haystack via "python manage.py build_solr_schema".
